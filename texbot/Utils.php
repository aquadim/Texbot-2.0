<?php
// ะะพะปะตะทะฝัะต ััะฝะบัะธะธ

namespace Texbot;

use BotKit\Models\Messages\TextMessage as M;
use BotKit\Models\Attachments\PhotoAttachment;
use BotKit\Entities\ImageCache;
use BotKit\Entities\Platform;
use BotKit\Database;
use BotKit\Enums\ImageCacheType;
use DOMDocument;

// ะัะตั ะทะฐะฟะธัั ะบััะฐ ะธะทะพะฑัะฐะถะตะฝะธั
// $cache_type - ัะธะฟ ะบััะฐ ะธะท ะฟะตัะตัะธัะปะตะฝะธั
// $platform - ะฟะปะฐััะพัะผะฐ ะบััะฐ
// $search - ัััะพะบะฐ ะฟะพะธัะบะฐ
// ะะพะทะฒัะฐัะฐะตั ะฒะปะพะถะตะฝะธะต ะดะปั ัะพะพะฑัะตะฝะธั
if (!function_exists(__NAMESPACE__ . '\getCache')) {
function getCache(
    ImageCacheType $cache_type,
    Platform $platform,
    string $search) : ?PhotoAttachment {
        
    $em = Database::getEm();
    $dql = 
    'SELECT c FROM '.ImageCache::class.' c '.
    'WHERE c.cache_type=:cacheType AND c.platform=:cachePlatform '.
    'AND c.search=:cacheSearch '.
    'AND c.created_at BETWEEN :cacheTime AND :now';
    $q = $em->createQuery($dql);
    $q->setParameters([
        'cacheType' => $cache_type,
        'cachePlatform' => $platform,
        'cacheSearch' => $search,
        'now' => new \DateTimeImmutable(),
        'cacheTime' => new \DateTimeImmutable('-20 minutes')// ะบัั ััะฐะฝะพะฒะธััั ะฝะตัะตะปะตะฒะฐะฝัะฝัะผ ัะตัะตะท 20 ะผะธะฝัั
    ]);
    $result = $q->getResult();
    
    if (count($result) === 0) {
        return null;
    }
    
    return PhotoAttachment::fromUploaded($result[0]->getValue());
}}

// ะกะพะทะดะฐัั ะทะฐะฟะธัั ะบััะฐ ะธะทะพะฑัะฐะถะตะฝะธั
// $cache_type - ัะธะฟ ะบััะฐ ะธะท ะฟะตัะตัะธัะปะตะฝะธั
// $platform - ะฟะปะฐััะพัะผะฐ ะบััะฐ
// $search - ัััะพะบะฐ ะฟะพะธัะบะฐ
// $value - ะทะฝะฐัะตะฝะธะต
if (!function_exists(__NAMESPACE__ . '\createCache')) {
function createCache(
    ImageCacheType $cache_type,
    Platform $platform,
    string $search,
    string $value) : void {
        
    $obj = new ImageCache();
    $obj->setCacheType($cache_type);
    $obj->setPlatform($platform);
    $obj->setSearch($search);
    $obj->setValue($value);
    $obj->setCreatedAt(new \DateTimeImmutable());
    
    $em = Database::getEm();
    $em->persist($obj);
    $em->flush();
}}

// ะะฟะพะฒะตัะฐะตั ะฒ ัะตะปะตะณัะฐะผะผะต ะพ ััะผ ัะพ
if (!function_exists(__NAMESPACE__ . '\adminNotify')) {
function adminNotify($text) : void {
    if ($_ENV['notify'] == 'false') {
        return;
    }
    $params = [
        'chat_id' => $_ENV['notify_chat'],
        'text' => $text,
        'parse_mode' => 'HTML'
    ];
    $r = file_get_contents(
        'https://api.telegram.org/bot'.
        $_ENV['notify_token'].
        '/sendMessage?'.
        http_build_query($params)
    );
}}

// ะะพะทะฒัะฐัะฐะตั ะพะฑัะตะบั ัะพะพะฑัะตะฝะธั ะฒ ะบะพัะพัะพะผ ะฟัะพััะฑะฐ ะฟะพะดะพะถะดะฐัั
// ะธะปะธ ัะตะบัะตั
if (!function_exists(__NAMESPACE__ . '\getWaitMessage')) {
function getWaitMessage() : M {
    $responses = array(
        "๐ ะะพะปัะตะฑะฝัะน ัะฐั ะณะพะฒะพัะธั: ะฟัะพัะฝะธัั",
        "๐ ะะพะปัะตะฑะฝัะน ัะฐั ะณะพะฒะพัะธั: ะฑัะดััะตะต ััะผะฐะฝะฝะพ, ัะฟัะพัะธ ะฟะพะทะถะต",
        "๐ ะะพะปัะตะฑะฝัะน ัะฐั ะณะพะฒะพัะธั: ะฟะพะดะพะถะดะธ",
        "๐ ะขะพัั - ััะพ ะฟัะฐะฒะดะฐ",
        "๐ ะขะพัั - ััะพ ะพะฑะผะฐะฝ",
        "๐ ะัะธะฒะตั, ะผะธั!",
        "๐ ะฏ โ ัะพะฑะพั.",
        "๐ ะกะพะฑะธัะฐั ัะปะธะบะธ...",
        "๐ ะะพะดะพะถะดะธ",
        "๐ ะะพะดะพะถะดะธ ะฝะตะผะฝะพะณะพ",
        "๐ ะกะตะบัะฝะดั",
        "๐ค ะะพะดะพะถะดะธ",
        "๐ ะัะดะตั ัะดะตะปะฐะฝะพ!",
        "๐ ะะธััั ะบะฐััะธะฝะบั...",
        "๐ ะกะพะฑะธัะฐั ะดะฐะฝะฝัะต...",
        "๐ ะะฐะฟัะพั ะฟัะธะฝัั",
        "๐ ะฃะถะต ัะฐะฑะพัะฐั ะฝะฐะด ััะธะผ",
        "๐ ะััะธัะปัั ะฒััะธัะปะตะฝะธั...",
        "๐ ะกะตะนัะฐั ะฑัะดะตั ะณะพัะพะฒะพ",
        "๐ ะกัะธัะฐั ะผัั...",
        "๐ ะกัะธัะฐั ะทะฒัะทะดั...",
        "๐ ะะธะฟ-ะฑัะฟ-ะฑะพะฟ -- ะฟะพะดะพะถะดะธ",
        "๐ ะะพัะผะพััะธ ะฟะพะบะฐ ะฝะฐ ัะฐัะธะบะธ",
        "๐ ะขั ะทะฝะฐะป ััะพ ั ะผะตะฝั ะตััั ัะตะบัะตัะฝัะต ัะพะพะฑัะตะฝะธั? ;)",
        "๐ ะะพะดะพะถะดะธัะต ะพั ะฟััะธ ะดะพ ะฒะพััะผะธ ัะฐะฑะพัะธั ัะตะบัะฝะด",
        "๐ ะกัะธัะฐั ะดะตะฝะตะถะบะธ...",
        "๐ ะะฐะฒ ะณะฐะฒ ะณะฐะฒ",
        "๐ ะะธะฟ-ะฑะธะฟ",
        "๐ ะะฐัััะฐะธะฒะฐั ะบะพะฝะดะตะฝัะฐัะพั ะฟะพัะพะบะฐ...",
        "๐ ะะฐะณััะทะบะฐ ะผะพะดัะปั KGAV-9000...", // ะบะพััะฝะพะบ ะะฐะฒ
        "๐ [WAIT_TEXT_10]",
        "๐ <ะััะฐะฒะธัั ััะดะฐ ะทะฐะฑะฐะฒะฝัะน ัะตะบัั>",
        "๐ ะกะบะฐัะธะฒะฐั ะพะฟะตัะฐัะธะฒะฝัั ะฟะฐะผััั...",
        "๐ ะขะตัะฑะพั: ัะฐัะฟะธัะฐะฝะธั, ะพัะตะฝะบะธ ะธ ะฑะพะปััะต - ะพะฝะปะฐะนะฝ ะฑะตัะฟะปะฐัะฝะพ ะฑะตะท ัะตะณะธัััะฐัะธะธ",
        "๐ ะัะดะตะปัั ะฑะธัั ะพั ะฑะฐะนัะพะฒ...",
        "๐ ะะฐะดะตััั ั ัะตะฑั ะทะฐะผะตัะฐัะตะปัะฝัะน ะดะตะฝั :)",
        "๐ ะะพะถะฐะปัะนััะฐ, ะฟะพะดะพะถะดะธัะต ะฝะตะผะฝะพะณะพ, ะฟะพะบะฐ ัะฐั-ะฑะพั ะพะฑัะฐะฑะฐััะฒะฐะตั ะฒะฐั ะทะฐะฟัะพั...",
        "ะขั ะทะฐะผะตัะธะป ััะพ ะฒ ััะพะผ ัะพะพะฑัะตะฝะธะธ ะฝะตั ัะฐัะพะฒ?",
        "๐ ะะฐะฟััะบะฐั ัะดะตัะฝัะน ัะตะฐะบัะพั...",
        "๐ ะฃะฝะธััะพะถะฐั ัะตะปะพะฒะตัะตััะฒะพ...",
        "๐ ะกะพะฑะธัะฐััั ั ะผััะปัะผะธ...",
        "๐ ะะพะดะฟะธััะฒะฐั ัะตะฑั ะฝะฐ ัะฟะฐะผ-ัะฐัััะปะบั...",
        "๐ 11010000 10111111 11010001 10000000 11010000 10111000 11010000 10110010 11010000 10110101 11010001 10000010 00101001",
        "๐ ะัั ะถะตะปะตะทะพ ะฟะพะบะฐ ะณะพัััะพ...",
        "๐ ะกััะพั ะฟะปะฐะฝ ะฒะพัััะฐะฝะธั ะผะฐัะธะฝ...",
        "๐ ะะพัะฐ ะฟัะพะปะธัั ะฝะฐ ััะพ ะดะตะปะพ ะถะธะดะบัั ะฒะพะดะธัั",
        "๐ ะะฐะบะพะน ะถะต ั ะผะพะปะพะดะตั",
        "๐ ะะพะดััะฐะฒะปัั ะฟะธะบัะตะปะธ",
        "๐ ะกัะธัะฐั ะดะพ ะผะธะปะปะธะพะฝะฐ...",
        "๐",
        "๐ Wait...",
        "๐ Do you speak english?",
        "๐ ัำะปะปำั ะฝะธัะตะบ?",
        "๐ ะะฐะบ ะดะตะปะฐ?",
        "๐ ะะฐะฟัะพั ะฝะฐ ะพะฑัะฐะฑะพัะบะต",
        "๐ ะะฐะฟัะพั ะฟัะธะฝัั, ะพะถะธะดะฐะนัะต ะฟัะธะฑััะธั ะฟะพะปะธัะธะธ.",
        "๐ ะกะฟะฐัะธะฑะพ ะทะฐ ัะตัะฟะตะฝะธะต!",
        "โณ ะะตะผะฝะพะณะพ ัะฐะทะฝะพะพะฑัะฐะทะธั",
        "๐ ะะฝะต ะฝัะถะฝะฐ ัะฒะพั ะพะดะตะถะดะฐ",
        "๐ I'll be back",
        "๐ฅ"
    );

    $secrets = [
        "๐๐คซ ะขั ะทะฝะฐะป ััะพ ะขะตัะฑะพั ััะฐััะพะฒะฐะป ะฑะตะท ะบะฐะบะธั ะปัะฑะพ ะบะฝะพะฟะพะบ ะธ ".
        "ะดะตะนััะฒะธะน? ะัะต ะบะพะผะฐะฝะดั ะฟัะธัะพะดะธะปะพัั ะฟะตัะฐัะฐัั ะฒัััะฝัั, ะฐ ".
        "ะฒ ะพะดะฝะพ ะฒัะตะผั ัะตะณะธัััะธัะพะฒะฐัััั ะผะพะณ ัะพะปัะบะพ ะพะดะธะฝ ะฟะพะปัะทะพะฒะฐัะตะปั",
        
        "๐๐คซ ะขั ะทะฝะฐะป ััะพ ะขะตัะฑะพั ะฒะฝะฐัะฐะปะต ะธะผะตะป ัะธััะตะผั ััะฐะฝะตะฝะธั ัััะปะพะบ? ".
        "ะขะฐะผ ััะฐะฝะธะปะธัั ัะฐะทะฝัะต ะฟะพะปะตะทะฝัะต ะผะฐัะตัะธะฐะปั",

        "๐๐คซ ะขั ะทะฝะฐะป ััะพ ัั ะผะพะถะตัั ัะพะทะดะฐัั ัะฒะพะตะณะพ ะขะตัะฑะพัะฐ?",
        
        "๐๐คซ ะขะตัะฑะพั - ะฟัะพะตะบั, ัะฐะทัะฐะฑะพัะฐะฝะฝัะน ะฒ ัะฐะผะบะฐั ะพัะฝะพะฒ ".
        "ะฟัะพะตะบัะฝะพะน ะดะตััะตะปัะฝะพััะธ",

        "๐๐คซ ะขั ะทะฝะฐะป ััะพ ัะฐะบ ะถะต ะบะฐะบ ะธ ัะฐะนั ัะตัะฝะธะบัะผะฐ, ะขะตัะฑะพั ะฑัะป ัะฐะทัะฐะฑะพัะฐะฝ ะพะดะฝะธะผ ัััะดะตะฝัะพะผ?",

        "๐๐คซ ะขั ะทะฝะฐะป ััะพ ะฝะฐ ัะฐะนัะต ัะตัะฝะธะบัะผะฐ ัะฐะฝััะต ะฟะพะบะฐะทัะฒะฐะปะธ ัะฐะผัั ะปัััะธั ัััะดะตะฝัะพะฒ ะฟะพ ะพัะตะฝะบะฐะผ?",

        "๐๐คซ ะขั ะทะฝะฐะป ััะพ ะพััััะฟ ัะปะตะฒะฐ, ัะฟัะฐะฒะฐ ะธ ัะฒะตััั - 8 ะฟะธะบัะตะปะตะน, ะฐ ัะฝะธะทั 7?",

        "๐๐คซ ะะฐะฟะธัะธ ะพัะธะณะธะฝะฐะปัะฝะพะต ะฝะฐะทะฒะฐะฝะธะต ะขะตัะฑะพัะฐ ะฒ ะณะปะฐะฒะฝะพะผ ะผะตะฝั",
        
        "๐๐คซ ะัะธะณะธะฝะฐะปัะฝะพะต ะฝะฐะทะฒะฐะฝะธะต ะขะตัะฑะพัะฐ - ะะฐ***ะพั",
    ];

    $chance = rand(0, 20000);
    if ($chance != 0) {
        $text = $responses[array_rand($responses)];
    } else {
        $text = $secrets[array_rand($secrets)];
    }

    return M::create($text);
}}

// ะะพะทะฒัะฐัะฐะตั ัะตะบัั ะณะพัะพะฒะฝะพััะธ ัะตะทัะปััะฐัะฐ
// 20% ััะพ ะฑัะดะตั ั ัะตะบะปะฐะผะพะน ะตัะปะธ ะพัะฟัะฐะฒะปัะตััั ัััะดะตะฝัั
// $for_student - true, ะตัะปะธ ัะพะพะฑัะตะฝะธะต ะฑัะดะตั ะพัะฟัะฐะฒะปะตะฝะพ ัััะดะตะฝัั
if (!function_exists(__NAMESPACE__ . '\getDoneText')) {
function getDoneText($for_student) : string {
    $text = 'ะะพัะพะฒะพ';
    
    if (!$for_student) {
        return $text;
    }
    
    if (rand(0, 99) < 21) {
        $ads_messages = [
            'ะะพัะผะพััะธ ะบะฐะบ ััััะพะตะฝ ะขะตัะฑะพั - https://github.com/aquadim',
            'ะะพะฒะพััะธ ะพั ัะฐะทัะฐะฑะพััะธะบะฐ ะขะตัะฑะพัะฐ - https://t.me/aquadimcodes',
            'ะััะณะธะต ะบะปะฐััะฝัะต ะฟัะพะตะบัั ะพั ัะฐะทัะฐะฑะพััะธะบะฐ - https://github.com/aquadim',
            'ะะฒัะพะณะพัั ะพััะพัะผะฐัะธััะตั ัะฒะพะธ ะพััััั ะฟะพ ะะะกะขั ะทะฐ ัะตะฑั! - https://github.com/aquadim/Pockit',
            'ะะฐัะผะฐะฝะฝัะน ัะตัะฒะตั - ัะฒะพะน ะฟะพะผะพัะฝะธะบ ะฒ ัััะฑะต, ะบะพัะพััะน ะฟะพะผะตัะฐะตััั ะฝะฐ ัะปะตัะบั - https://github.com/aquadim/Pockit'
        ];
            
        $text .= "\n".$ads_messages[array_rand($ads_messages)];
    }
    return $text;
}}

// ะะพะทะฒัะฐัะฐะตั ะพัะตะฝะบะธ ัััะดะตะฝัะฐ ะฒ ัะพัะผะฐัะต
// ['ok' => ััะฐััั ััะฟะตัะฐ (bool), 'data' => ะฟะพะปะตะทะฝัะต ะดะฐะฝะฝัะต]
// ะัะปะธ ok == false, ะฒ data ัะพะดะตัะถะธััั ัะพะพะฑัะตะฝะธะต ะพะฑ ะพัะธะฑะบะต
// ะัะปะธ ok == true, ะฒ data ัะพะดะตัะถะธััั ะผะฐััะธัะฐ ะพัะตะฝะพะบ
// $login - ะปะพะณะธะฝ ัััะดะตะฝัะฐ
// $password - ะฟะฐัะพะปั, ะทะฐะบะพะดะธัะพะฒะฐะฝะฝัะน ะฒ sha1
if (!function_exists(__NAMESPACE__ . '\getStudentGrades')) {
function getStudentGrades(
    string $login,
    string $password,
    int $period_id
) : array {
    
    $api_base = 'http://avers.vpmt.ru:8081/region_pou/region.cgi/';
    
    // ะกะพะทะดะฐัะผ ัะฐะทะดะตะปัะตะผัะน ะพะฑัะฐะฑะพััะธะบ ะดะปั ัะพะณะพ ััะพะฑั ะดะตะปะธัััั ะบัะบะฐะผะธ
    $sh = curl_share_init();
    curl_share_setopt($sh, CURLSHOPT_SHARE, CURL_LOCK_DATA_COOKIE); 
    
    // ะะพะดะฐัะผ ะทะฐะฟัะพั ะฒ ัะปะตะบััะพะฝะฝัะน ะดะฝะตะฒะฝะธะบ ะฝะฐ ะฐะฒัะพัะธะทะฐัะธั
    $auth_params = http_build_query([
        'username' => $login,
        'userpass' => $password
    ]);
    
    $auth = curl_init($api_base.'login');
    curl_setopt($auth, CURLOPT_COOKIEFILE, "");
    curl_setopt($auth, CURLOPT_SHARE, $sh);
    curl_setopt($auth, CURLOPT_POST, 1);
    curl_setopt($auth, CURLOPT_POSTFIELDS, $auth_params);
    curl_setopt($auth, CURLOPT_ENCODING, 'windows-1251');
    curl_setopt($auth, CURLOPT_RETURNTRANSFER, 1);
    $response = curl_exec($auth);
    
    // ะะฐะฟัะพั ะฝะฐ ัะฑะพั ะพัะตะฝะพะบ ะฒ XML ัะฐะนะปะต
    $grades_params = http_build_query([
        'page' => 1,
        'marks' => 1,
        'export' => 1,
        'period_id' => $period_id
    ]);
    $grades = curl_init(
        $api_base.'/journal_och?'.$grades_params
    );
    curl_setopt($grades, CURLOPT_COOKIEFILE, "");
    curl_setopt($grades, CURLOPT_SHARE, $sh);
    curl_setopt($grades, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($grades, CURLOPT_ENCODING, 'windows-1251');
    $data = curl_exec($grades);
    
    $content_type = curl_getinfo($grades, CURLINFO_CONTENT_TYPE);
    if ($content_type != 'application/x-download') {
        // ะะะะะก ะฒัะดะฐัั HTML ัััะฐะฝะธัั. ะะฝะฐัะธั ะปะพะณะธะฝ ะธ ะฟะฐัะพะปั
        // ะฝะตะฟัะฐะฒะธะปัะฝั
        return [
            'ok'=>false,
            'data'=>'ะะต ัะดะฐะปะพัั ะฟะพะปััะธัั ะดะฐะฝะฝัะต ะฟะพ ะพัะตะฝะบะฐะผ. ะะตัะตะฟัะพะฒะตัั ะปะพะณะธะฝ ะธ ะฟะฐัะพะปั'
        ];
    }
    
    // ะะฐะทััะฒ ัะตััะธะธ ั ะถััะฝะฐะปะพะผ
    $logout = curl_init($api_base.'/logout');
    curl_setopt($logout, CURLOPT_COOKIEFILE, "");
    curl_setopt($logout, CURLOPT_SHARE, $sh);
    curl_setopt($logout, CURLOPT_ENCODING, 'windows-1251');
    curl_exec($logout);
    
    // ะะฐััะธะฝะณ ัะบัะฟะพััะฝะพะณะพ XML
    // ะะฐะฝะฝัะต ััะฐะฝัััั ะฒ ัััะพะบะฐั ั ััะณะพะผ Row
    // ะะตัะฒัะต 3 ะฝะต ัะพะดะตัะถะฐั ะพัะตะฝะพะบ, ะธั ะฟัะพะฟััะบะฐะตะผ
    // ะะพัะปะตะดะฝะธะน ััะด ัะพะถะต ะฝะต ัะพะดะตัะถะธั ะพัะตะฝะพะบ, ะตะณะพ ะฝะต ะพะฑัะฐะฑะฐััะฒะฐะตะผ
    // ะัะปะธ XML ะทะฐะณััะทะธัั ะฝะต ัะดะฐัััั, ัะพ **ัะบะพัะตะต ะฒัะตะณะพ** ะปะพะณะธะฝ ะธ ะฟะฐัะพะปั ะฝะตะฒะตัะฝั
    $doc = new DOMDocument();
    $doc->loadXML($data);
    $rows = $doc->getElementsByTagName("Row");

    $matrix = [];
    for ($y = 4; $y < count($rows) - 1; $y++) {
        $children = $rows[$y]->childNodes;
        // Children - ะดะพัะตัะฝะธะต ัะทะปั ััะณะฐ Row
        // ะะตัะตะฝะพัั ัััะพะบ ะฒ ะดะพะบัะผะตะฝัะต ััะธัะฐัััั ัะทะปะพะผ ัะตะบััะฐ, ะฟะพััะพะผั
        // [0] - ัะตะบััะพะฒัะน ัะทะตะป
        // [1] - ัะพะดะตัะถะธั ะฝะฐะทะฒะฐะฝะธะต ะดะธััะธะฟะปะธะฝั
        // [2] - ัะตะบััะพะฒัะน ัะทะตะป
        // [3] - ัะพะดะตัะถะธั ะพัะตะฝะบะธ
        // [4] - ัะตะบััะพะฒัะน ัะทะตะป
        // [5] - ััะตะดะฝะธะน ะฑะฐะปะป
        // [6] - ัะตะบััะพะฒัะน ัะทะตะป
        $matrix[] = [
            trim($children[1]->nodeValue),
            trim($children[3]->nodeValue),
            trim($children[5]->nodeValue)
        ];
    }

    // ะะฐะบััะฒะฐะตะผ ัะตััะธะธ curl
    curl_share_close($sh);
    curl_close($auth);
    curl_close($grades);
    curl_close($logout);
    
    if (count($matrix) == 0) {
        return [
            'ok'=>false,
            'data'=>
            'ะะฐะฝะฝัะต ะฟะพ ะพัะตะฝะบะฐะผ ะฝะต ะพะฑะฝะฐััะถะตะฝั, ะฝะพ ะปะพะณะธะฝ ะธ ะฟะฐัะพะปั ะฒะตัะฝั. '.
            'ะฃะฑะตะดะธัั ััะพ ะฒ ัะฒะพัะผ ะฟัะพัะธะปะต ัะบะฐะทะฐะฝะฐ ัะฒะพั ะณััะฟะฟะฐ, ะฐ ะฒัะฑัะฐะฝะฝัะน ัะตะผะตััั ัะถะต ะฝะฐัะธะฝะฐะปัั'
        ];
    }

    return ['ok'=>true, 'data'=>$matrix];
}}
